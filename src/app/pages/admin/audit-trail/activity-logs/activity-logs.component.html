<div class="min-h-screen bg-gray-50 flex">
  <!-- Sidebar -->
  <app-sidebar></app-sidebar>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col">
    <!-- Header -->
    <app-header 
      [breadcrumbs]="breadcrumbs"
      title="Activity Logs"
    ></app-header>

    <!-- Page Content -->
    <main class="flex-1 p-6">
      <div class="max-w-7xl mx-auto">
                 <!-- New Activity Notification -->
         <div *ngIf="(activityLogsService.newActivityDetected$ | async)" 
              class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4 animate-pulse">
           <div class="flex items-center">
             <div class="flex-shrink-0">
               <i class="fas fa-bell text-green-400"></i>
             </div>
             <div class="ml-3">
               <p class="text-sm font-medium text-green-800">New Activity Detected!</p>
               <p class="text-xs text-green-700">Activity logs have been updated with new data.</p>
             </div>
           </div>
         </div>

         <!-- Page Header -->
         <div class="bg-white rounded-lg shadow-lg border border-gray-200 p-6 mb-6">
          <div class="flex justify-between items-center">
            <div>
              <h1 class="text-3xl font-bold text-gray-900 mb-2">Activity Logs</h1>
                             <p class="text-gray-600">System actions performed by users across modules.</p>
               <p class="text-xs text-gray-500 mt-1">
                 Last updated: {{ (activityLogsService.lastUpdateTime$ | async) | date:'medium' }}
               </p>
            </div>
                                      <div class="flex gap-2">
               <!-- Real-time indicator and controls -->
               <div class="flex items-center gap-2 mr-4">
                 <div class="flex items-center gap-2">
                   <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                   <span class="text-sm text-gray-600">Real-time</span>
                 </div>
                 <button 
                   (click)="toggleRealTime()" 
                   class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors"
                 >
                   {{ isRealTimeEnabled ? 'Pause' : 'Resume' }}
                 </button>
                 <button 
                   (click)="manualRefresh()" 
                   class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors"
                   title="Refresh now"
                 >
                   <i class="fas fa-sync-alt"></i>
                 </button>
               </div>
               
               <button 
                 (click)="toggleFilters()" 
                 class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
               >
                 <i class="fas fa-filter mr-2"></i>
                 {{ showFilters ? 'Hide' : 'Show' }} Filters
               </button>
               <button 
                 (click)="exportToCSV()" 
                 [disabled]="exporting"
                 class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
               >
                 <i class="fas fa-download mr-2"></i>
                 {{ exporting ? 'Exporting...' : 'Export CSV' }}
               </button>
             </div>
          </div>
        </div>

        <!-- Summary Cards -->
        <div *ngIf="summary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center">
              <div class="p-2 bg-blue-100 rounded-lg">
                <i class="fas fa-chart-line text-blue-600"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Total Logs</p>
                <p class="text-2xl font-bold text-gray-900">{{ summary.data.totalLogs }}</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center">
              <div class="p-2 bg-green-100 rounded-lg">
                <i class="fas fa-clock text-green-600"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Last 24 Hours</p>
                <p class="text-2xl font-bold text-gray-900">{{ summary.data.recentActivityCount }}</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center">
              <div class="p-2 bg-yellow-100 rounded-lg">
                <i class="fas fa-exclamation-triangle text-yellow-600"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Warnings</p>
                <p class="text-2xl font-bold text-gray-900">
                  {{ getWarningCount() }}
                </p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center">
              <div class="p-2 bg-red-100 rounded-lg">
                <i class="fas fa-times-circle text-red-600"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Errors</p>
                <p class="text-2xl font-bold text-gray-900">
                  {{ getErrorCount() }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Filters Section -->
        <div *ngIf="showFilters" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Filters</h3>
          <form [formGroup]="filtersForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Entity</label>
              <input 
                type="text" 
                formControlName="entity"
                placeholder="Filter by entity (e.g., User, Employee)"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Action</label>
              <select 
                formControlName="action"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">All Actions</option>
                <option value="CREATE">Create</option>
                <option value="UPDATE">Update</option>
                <option value="DELETE">Delete</option>
                <option value="PROCESS">Process</option>
                <option value="LOGIN">Login</option>
                <option value="LOGOUT">Logout</option>
                <option value="APPROVE">Approve</option>
                <option value="REJECT">Reject</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Severity</label>
              <select 
                formControlName="severity"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">All Severities</option>
                <option value="info">Info</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
                <option value="critical">Critical</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">IP Address</label>
              <input 
                type="text" 
                formControlName="ipAddress"
                placeholder="Filter by IP address..."
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
              <input 
                type="date" 
                formControlName="startDate"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
              <input 
                type="date" 
                formControlName="endDate"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
              <input 
                type="text" 
                formControlName="search"
                placeholder="Search in details, entity, action..."
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
            </div>
          </form>
          <div class="mt-4 flex justify-end">
            <button 
              type="button"
              (click)="clearFilters()" 
              class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
            >
              Clear Filters
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="loading" class="text-center py-12 loading-state">
          <div class="icon">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          </div>
          <p class="title">Loading activity logs...</p>
        </div>

        <!-- Error State -->
        <div *ngIf="error && !loading" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="fas fa-exclamation-circle text-red-400"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">Error</h3>
              <p class="mt-1 text-sm text-red-700">{{ error }}</p>
            </div>
          </div>
        </div>

        <!-- Activity Logs Table -->
        <div *ngIf="!loading && !error" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <!-- Desktop and Medium Table View (all columns always visible) -->
          <div class="hidden sm:block">
            <table class="w-full divide-y divide-gray-200 activity-logs-table">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Date</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">User</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Entity</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Action</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Details</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">IP Address</th>
                  <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Severity</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr *ngFor="let log of activityLogs" class="hover:bg-gray-50 table-row">
                  <td class="px-3 py-4 text-sm text-gray-900">
                    {{ formatDate(log.createdAt) }}
                  </td>
                  <td class="px-3 py-4">
                    <div class="text-sm text-gray-900">{{ getUserDisplayName(log) }}</div>
                    <div class="text-xs text-gray-500" *ngIf="log.user && log.user.role">
                      {{ getRoleDisplayName(log.user.role) }}
                    </div>
                  </td>
                  <td class="px-3 py-4">
                    <div class="text-sm text-gray-900">{{ log.entity }}</div>
                    <div class="text-xs text-gray-500">ID: {{ log.entityId }}</div>
                  </td>
                  <td class="px-3 py-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium badge"
                          [ngClass]="getActionColor(log.action)">
                      <i class="fas mr-1" [ngClass]="getActionIcon(log.action)"></i>
                      {{ log.action }}
                    </span>
                  </td>
                  <td class="px-3 py-4 text-sm text-gray-900">
                    <div class="max-w-xs">
                      <span class="truncate block" [title]="log.details || 'No details provided'">
                        {{ log.details || 'No details provided' }}
                      </span>
                    </div>
                  </td>
                  <td class="px-3 py-4 text-sm text-gray-900">
                    <div class="ip-address" [title]="log.ipAddress || 'N/A'">
                      {{ log.ipAddress || 'N/A' }}
                    </div>
                  </td>
                  <td class="px-3 py-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium badge"
                          [ngClass]="getSeverityColor(log.severity)">
                      {{ log.severity }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Mobile Card View (very small screens only) -->
          <div class="sm:hidden mobile-cards">
            <div *ngFor="let log of activityLogs" class="p-4 border-b border-gray-200 last:border-b-0 hover:bg-gray-50 log-item">
              <div class="log-header">
                <div class="flex-1">
                  <div class="text-sm font-medium text-gray-900">{{ getUserDisplayName(log) }}</div>
                  <div class="text-xs text-gray-500" *ngIf="log.user && log.user.role">
                    {{ getRoleDisplayName(log.user.role) }}
                  </div>
                </div>
                <div class="flex flex-col items-end space-y-1">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium badge"
                        [ngClass]="getActionColor(log.action)">
                    <i class="fas mr-1" [ngClass]="getActionIcon(log.action)"></i>
                    {{ log.action }}
                  </span>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium badge"
                        [ngClass]="getSeverityColor(log.severity)">
                    {{ log.severity }}
                  </span>
                </div>
              </div>

              <div class="log-content">
                <!-- Entity Info -->
                <div class="log-field">
                  <span class="label">Entity:</span>
                  <span class="value">{{ log.entity }} (ID: {{ log.entityId }})</span>
                </div>

                <!-- Details -->
                <div class="log-field" *ngIf="log.details">
                  <span class="label">Details:</span>
                  <span class="value">{{ log.details }}</span>
                </div>

                <!-- IP Address -->
                <div class="log-field">
                  <span class="label">IP:</span>
                  <span class="value ip-address">{{ log.ipAddress || 'N/A' }}</span>
                </div>

                <!-- Date -->
                <div class="text-sm text-gray-500 mt-2">
                  {{ formatDate(log.createdAt) }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div *ngIf="!loading && !error && totalPages > 1" class="mt-6 flex items-center justify-between">
          <div class="flex items-center text-sm text-gray-700">
            <span>Showing {{ (currentPage - 1) * pageSize + 1 }} to {{ getMaxPageItems() }} of {{ totalItems }} results</span>
          </div>
          <div class="flex items-center space-x-2">
            <button 
              (click)="onPageChange(currentPage - 1)"
              [disabled]="currentPage === 1"
              class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50"
            >
              Previous
            </button>
            <span class="px-3 py-2 text-sm text-gray-700">
              Page {{ currentPage }} of {{ totalPages }}
            </span>
            <button 
              (click)="onPageChange(currentPage + 1)"
              [disabled]="currentPage === totalPages"
              class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50"
            >
              Next
            </button>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!loading && !error && activityLogs.length === 0" class="text-center py-12 empty-state">
          <div class="icon">
            <i class="fas fa-clipboard-list text-gray-400"></i>
          </div>
          <h3 class="title">No activity logs found</h3>
          <p class="description">There are no activity logs matching your current filters.</p>
        </div>
      </div>
    </main>
  </div>
</div>
